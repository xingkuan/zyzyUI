<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>3D JL sys</title>
</head>

<link href = "../jquery/jquery-ui.css" rel = "stylesheet">

<link href = "JLeditor.css" rel = "stylesheet">

<script src="javascripts/dat.gui.min.js"></script>

<script src="../jquery/jquery-3.3.1.min.js"></script>

<script src="../jquery/jquery-ui.js"></script>

<style>

</style>


<body>
<!-- for prototyping -->
<div id="debug">
  <div id="mouseCoScreen"></div>
  <div id="renderRect"></div>
  <div id="mouseCoNorm"></div>
  <div id="cameraCo"></div>
  <div id="intersectObjs"></div>
</div>

<!-- pop up form -->
<div id="editDialog" title="edit point" >
<form id=f1>
  <p>
  <span id="ptrX"></span>,<span id="ptrY"></span><span id="ptrZ"></span><br>
    Line: <input list="dataLineList" id="uiLine" name="uiLine" />
	<datalist id="dataLineList"></datalist>
  <br>
  Point: <input list="dataPtrList" id="uiPoint" name="uiPoint" />
	<datalist id="dataPtrList"></datalist>
  <br>
  Seq: <input type="number" id="uiSeq" name="uiSeq" />
  <br>
  expond:<textarea id="xpond" name="nameExpond" cols=40 rows=3 ></textarea>
  <br>
  apps:<textarea id="apps" name="apps" cols=40 rows=3 ></textarea>
  <br>
  desc:<textarea id="desc" name="desc" cols=40 rows=3 ></textarea>
</form>
</div>


<div id="container" class="container">
	<canvas id="c"></canvas>
    <div id="labels"></div>
	<div id="modelCtrl"></div>
</div>

<canvas id="dummyCanvas" width="64" height="64"></canvas>
<div id="xx">
<!-- button onclick="showJL()">show JingLuo</button  NOT working as showJL() is in a module!? -->
<button id="showJL">show JingLuo</button>

</div>


<script type="module">
import * as THREE from './threejs/build/three.module.js'

//used in raycast
var interceptMark;   

//var camera, scene, renderer, CameraCtrl; 
import {init3D, loadGLTF, render, addPointToJLObjs, showJL} from './JLeditorGlobals.js';

//hookup showJL() to button "#showJL"
$("#showJL").click( e=> {
console.log("to showJL"); 
showJL() 
} 
);


//setup the 'JLnames'. When selected, the path of the JingLuo will be created and added to the scene.  
//populateField("http://localhost:8080/zyzySvc/JL/getJLs",   ////init Line List of the popup;
//	function(e){
//		//populate the dropdown list
//		$("#JLnames").append($("<option>"+e["line_name"]+"</option>").attr("value", e["line_name"]));
//	}
//);  

 

//initGlobalVars();
setupPopup()  ;
init3D('#c', 30);
loadGLTF('as_fem2.glb');

import {populateField} from './JLeditor.js';

//initModelCtrl();  //2021.06.03 leave it in loadGLTF(), because of the nature of asynchronous. 
//2021.06.10 Do not animate. re-render only upand mouse events
//requestAnimationFrame(render);  // this way, "time" can be passed to render()


//2021.06.17 don't do it yet. render(e=>{d=new Date();return d.getTime();});

//********************************************************
////// set up the pop up for entering infomations.
function setupPopup(){
$( "#editDialog" ).dialog({
	autoOpen: false,
	modal: true,
	//position:pos,
 	buttons: {
    	 "Close ": function() {
	    	$(this).dialog( "close" );
      	},
     	"Submit ": function(){
	  		//console.log($("#uiLine").val()+","+$("#uiPoint").val());
	     	savePoint(composeData);
	   		//re-enable 3D object event handler.
	     	$("#container").attr('disabled','auto');		
			$( this ).dialog( "close" );
			//clear input fields
			$('#uiLine').text("");
			$('#uiPoint').text("");
			$('#uiSeq').text("");
     	}
	}
});
//popup form field event hanlers
$("#uiLine").blur(function(){
	//alert($(this).val());
	populateField("http://localhost:8080/zyzySvc/JL/getPointsByJL/"+$(this).val(), 
		e=>{
			//the drop down list in the pop-up
			$("#dataPtrList").empty();
			$("#dataPtrList").append($("<option></option>").attr("value", e["name"]));
			//if column "coor" contains value, then create the 3D point and add to the scene.
			let ptr;
			if (e['coor'] != null){
				ptr = new THREE.Vector3(e['coor']['x'], e['coor']['y'], e['coor']['z']);
				addPointToJLObjs(e["line_name"], e["name"], ptr);
			}
		}
	);
});
$("#uiPoint").blur(function(){
	//alert($(this).val());
	populateField("http://localhost:8080/zyzySvc/JL/getPointByName/"+$("#uiLine").val() +"/"+$(this).val(), 
		e=>{$("#uiSeq").val(e["seq"]);
			$("#xpond").text(e["name_explained"]);
			$("#apps").text(e["applications"]);
			$("#desc").text(e["description"]);
		});
});

populateField("http://localhost:8080/zyzySvc/JL/getJLs",   ////init Line List of the popup;
		function(e){
			//populate the dropdown list
			$("#dataLineList").append($("<option></option>").attr("value", e["line_name"]));
			//add 3D points to the 3D model
		});  
};  //end setupPopup()

////////////////////











//var flowTexture;   //needed global var so it can be accessed from within render()  
/*2021.06.16  This is certainly not doing anything !!!
function resizeRendererToDisplaySize(renderer) {
    const canvas = renderer.domElement;
    const width = canvas.clientWidth;
    const height = canvas.clientHeight;
    const needResize = canvas.width !== width || canvas.height !== height;
    if (needResize) {
      renderer.setSize(width, height, false);
    }
    return needResize;
}




let del = 0;  // between each two points, interpolate 2 points to simulate flow. 
			  // TODO: Should use GPU as well.
function updateParticles(){ 
	if (del==2){
		del=0;
	}else{
		del=(del+1);
	}
	ptrObjs.children.forEach((child, ndx) => {
		child.material.uniforms.del.value=del * 0.3;
		child.needsUpdate = true;
	})
}    
*/

/////////////////////////////////////    
function composeData() {
	/*    return JSON.stringify({
	 "cat": $('input[name="cat"]:checked').val(),
	 "data": $('#txtNote').val()
	 })
	 */
	//alert($('#selRelation option:selected').val());
	var strRslt, rsltObj;
	rsltObj = {
		line_name:	$('#uiLine').val(),
		name:	$('#uiPoint').val(),
		seq:	$('#uiSeq').val(),
		x:	$('#ptrX').text(),
		y:	$('#ptrY').text(),
		z:	$('#ptrZ').text()
		
	};
	
	//alert(typeof rsltObj );
	let json= JSON.stringify(rsltObj)

	//return strRslt;
	return json;
}   




</script>


<script type="module">
//var TransformControls = require('threejs-transformcontrols');
import { TransformControls } from "./javascripts/TransformControls.js";
//2021.06.15--------------
//https://threejs.org/examples/webgl_geometry_spline_editor.html
/*
var transformControl = new TransformControls( camera, canvas );
				transformControl.addEventListener( 'change', render );
				transformControl.addEventListener( 'dragging-changed', function ( event ) {
					controls.enabled = ! event.value;
				} );
				scene.add( transformControl );

				transformControl.addEventListener( 'objectChange', function () {
					updateSplineOutline();
				} );


const splineHelperObjects = [];
const pointer = new THREE.Vector2();
const onUpPosition = new THREE.Vector2();
const onDownPosition = new THREE.Vector2();
			
				document.addEventListener( 'pointerdown', onPointerDown );
				document.addEventListener( 'pointerup', onPointerUp );
				document.addEventListener( 'pointermove', onPointerMove );


			function onPointerDown( event ) {
				onDownPosition.x = event.clientX;
				onDownPosition.y = event.clientY;
			}

			function onPointerUp() {
				onUpPosition.x = event.clientX;
				onUpPosition.y = event.clientY;

				if ( onDownPosition.distanceTo( onUpPosition ) === 0 ) transformControl.detach();
			}

			function onPointerMove( event ) {
				pointer.x = ( event.clientX / window.innerWidth ) * 2 - 1;
				pointer.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

				raycaster.setFromCamera( pointer, camera );

				const intersects = raycaster.intersectObjects( splineHelperObjects );
				if ( intersects.length > 0 ) {
					const object = intersects[ 0 ].object;

					if ( object !== transformControl.object ) {
						transformControl.attach( object );
					}
				}
			}

			function addPoint() {
				splinePointsLength ++;

				positions.push( addSplineObject().position );
				updateSplineOutline();
			}

			function removePoint() {
				if ( splinePointsLength <= 4 ) {
					return;
				}

				const point = splineHelperObjects.pop();
				splinePointsLength --;
				positions.pop();

				if ( transformControl.object === point ) transformControl.detach();
				scene.remove( point );

				updateSplineOutline();
			}

			function updateSplineOutline() {
				for ( const k in splines ) {
					const spline = splines[ k ];

					const splineMesh = spline.mesh;
					const position = splineMesh.geometry.attributes.position;

					for ( let i = 0; i < ARC_SEGMENTS; i ++ ) {
						const t = i / ( ARC_SEGMENTS - 1 );
						spline.getPoint( t, point );
						position.setXYZ( i, point.x, point.y, point.z );
					}

					position.needsUpdate = true;
				}
			}
			
*/


</script>




</body>
</html>
